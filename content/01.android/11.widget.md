---
title: ウィジェットの実装
description: ウィジェットに関する実装
navigation: true
draft: true
date: 2025-09-08T07:00:00+09:00
---

## ウィジェット機能を実装したい

### 実装手順

1.  レイアウトファイルを用意する
2.  ウィジェット用の設定ファイルを追加する
3.  `AppWidgetProvider`のサブクラスを作成する
4.  `AndroidManifest.xml`に追記する

### レイアウトを用意する

ウィジェットとして表示するレイアウトファイルを追加する。
通常のレイアウトファイルと同様、`res/layout`フォルダに配置する。
ここでは`widget_sample_view.xml`とする。

```xml
<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent">
    <Button
        android:text="Button"
        android:layout_width="match_parent"
        android:layout_height="match_parent"/>
</FrameLayout>
```

### ウィジェット用の設定ファイルを追加する

アプリがウィジェット機能を備えていることをOS側に認識させるため、設定ファイルを作成する。
作成したファイルは`res/xml`フォルダに配置する。（ここでは`widget_provider.xml`とする）

```xml
<?xml version="1.0" encoding="utf-8"?>
<appwidget-provider xmlns:android="http://schemas.android.com/apk/res/android"
    android:initialLayout="@layout/widget_sample_view"
    android:minHeight="100dp"
    android:minWidth="200dp"
    android:updatePeriodMillis="1000000" >
</appwidget-provider>
```

### AppWidgetProviderのサブクラスを作成する

`AppWidgetProvider`を継承したカスタムクラスを作成する。
今回は`SampleWidgetProvider`として以下を作成。

```java
class SampleWidgetProvider : AppWidgetProvider() {

  override fun onUpdate(
    context: Context?,
    appWidgetManager: AppWidgetManager?,
    appWidgetIds: IntArray?
  ) {
    context ?: return
    val remoteViews = RemoteViews(context.packageName, R.layout.widget_sample_view)

    val widget = ComponentName(context, SampleWidgetProvider::class.java)
    appWidgetManager?.updateAppWidget(widget, remoteViews)
  }

}
```

### AndroidManifest.xmlに追記する

`AndroidManifest.xml`に前項までに追加した設定ファイルとクラスを追記します。`receiver`タグで`SampleWidgetProvider`を追加し、ウィジェットのアップデート通知を受け取るための`intent-filter`、そして前項で作成した設定ファイルを`meta-data`としてタグ内に設定します。

```xml
  <application
      ...>
      
      <receiver android:name=".SampleWidgetProvider"
          android:exported="true">
          <intent-filter>
            <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
          </intent-filter>

          <meta-data
            android:name="android.appwidget.provider"
            android:resource="@xml/widget_provider" />
      </receiver>

  </application>
```

ここまで実装すれば、作成したウィジェットをホーム画面に配置することができます。

## ウィジェット内のViewにクリックリスナーを設定したい

ウィジェット内にクリックリスナーを設定する場合、通常のクリックリスナーと異なり、実装できるのは`Intent`を発火させるだけ。
このIntentを`Activity`や`Service`、`BroadcastReceiver`で受け取り、必要な処理を実施する。
画面を表示したいなら`Activity`、画面を表示せず情報を更新したい場合などは`Service`や`BroadcastReceiver`が通知先となる。

たとえば以下の例は、`SampleActivity`を起動する場合（何らかの画面を表示するケース）。
`RemoteViews.setPendingIntent`を使って、クリックリスナーを設定したいViewのIDと、
そのViewがタップされたときに発火する`Intent`（`PendingIntent`）を渡す。

```java
class SampleWidgetProvider : AppWidgetProvider() {

  override fun onUpdate(
    context: Context?,
    appWidgetManager: AppWidgetManager?,
    appWidgetIds: IntArray?
  ) {
    context ?: return
    val remoteViews = RemoteViews(context.packageName, R.layout.widget_sample_view)

    // ボタンがタップされた時のintent(PendingIntent)を設定
    remoteViews.setOnClickPendingIntent(R.id.button, createPendingIntent(context))
    val widget = ComponentName(context, SampleWidgetProvider::class.java)
    appWidgetManager?.updateAppWidget(widget, remoteViews)
  }

  private fun createPendingIntent(context: Context): PendingIntent {
    // SampleActivityを通知先として指定
    val intent = Intent(context, SampleActivity::class.java)  
    // 通知先がActivityなので、PendingIntent.getActivityでPendingIntentを生成。
    // requestCodeやflagは任意の値
    return PendingIntent.getActivity(context, 100, intent, PendingIntent.FLAG_IMMUTABLE)
  }
}
```

### 参考

  * [シンプルなウィジェットを作成する | Views | Android Developers](https://developer.android.com/develop/ui/views/appwidgets?hl=ja)
  * [RemoteViews | API reference | Android Developers](https://developer.android.com/reference/android/widget/RemoteViews)
  * [Androidでの簡易なWidget作り方 \#Android - Qiita](https://qiita.com/aaari/items/6c1fc66ef95ec77980c6)